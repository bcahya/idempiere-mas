<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="SalesReportBasedOnSupplier" language="groovy" pageWidth="842" pageHeight="595" orientation="Landscape" columnWidth="802" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="94006966-f21f-4402-b1e1-2d636ed7f308">
	<property name="ireport.zoom" value="0.9090909090909107"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<style name="Crosstab Data Text" hAlign="Center"/>
	<parameter name="AD_User_ID" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="DateFrom" class="java.util.Date">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="DateTo" class="java.util.Date">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="ReportType" class="java.lang.String"/>
	<parameter name="SUBREPORT_DIR" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA["D:\\work\\project\\UntaCore@FLG\\com.unicore.order\\src\\jasper\\"]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT Master.Partner, Master.Item, SUM(Master.QtySale) AS QtySale, SUM(Master.Sale) AS Sale, SUM(Master.QtyRetur) AS QtyRetur, SUM(Master.Retur) AS Retur, Master.UOM, Master.now, Master.User FROM (SELECT bp.Name AS Partner, p.Name as Item, SUM(il.QtyEntered) AS QtySale, SUM(il.LineNetAmt) AS Sale, 0 AS QtyRetur, 0 AS Retur, uom.UOMSymbol AS UOM, now() AS now, us.Name AS User

FROM C_Invoice iv

INNER JOIN C_InvoiceLine il ON il.C_Invoice_ID = iv.C_Invoice_ID
INNER JOIN M_Product p ON p.M_Product_ID = il.M_Product_ID
INNER JOIN C_UOM uom ON uom.C_UOM_ID = p.C_UOM_ID
INNER JOIN C_BPartner_Product bpp ON bpp.M_Product_ID = p.M_Product_ID AND bpp.IsActive = 'Y'
INNER JOIN C_BPartner bp ON bp.C_BPartner_ID = bpp.C_BPartner_ID
INNER JOIN C_DocType dt ON dt.C_DocType_ID = iv.C_DocType_ID
INNER JOIN AD_User us ON us.AD_User_ID = $P{AD_User_ID}

WHERE iv.DocStatus IN ('CO', 'CL') AND iv.IsSOTrx = 'Y' AND iv.DateInvoiced BETWEEN $P{DateFrom} AND $P{DateTo} AND dt.DocBaseType = 'ARI' AND p.IsSold = 'Y' AND p.IsPurchased = 'Y'

GROUP BY bp.C_BPartner_ID, p.M_Product_ID, uom.C_UOM_ID, us.AD_User_ID

UNION ALL

SELECT bp.Name AS Partner, p.Name as Item, 0 AS QtySale, 0 AS Sale, SUM(il.QtyEntered) AS QtyRetur, SUM(il.LineNetAmt) AS Retur, uom.UOMSymbol AS UOM, now() AS now, us.Name AS User

FROM C_Invoice iv

INNER JOIN C_InvoiceLine il ON il.C_Invoice_ID = iv.C_Invoice_ID
INNER JOIN M_Product p ON p.M_Product_ID = il.M_Product_ID
INNER JOIN C_UOM uom ON uom.C_UOM_ID = p.C_UOM_ID
INNER JOIN C_BPartner_Product bpp ON bpp.M_Product_ID = p.M_Product_ID AND bpp.IsActive = 'Y'
INNER JOIN C_BPartner bp ON bp.C_BPartner_ID = bpp.C_BPartner_ID
INNER JOIN C_DocType dt ON dt.C_DocType_ID = iv.C_DocType_ID
INNER JOIN AD_User us ON us.AD_User_ID = $P{AD_User_ID}

WHERE iv.DocStatus IN ('CO', 'CL') AND iv.IsSOTrx = 'Y' AND iv.DateInvoiced BETWEEN $P{DateFrom} AND $P{DateTo} AND dt.DocBaseType = 'ARC' AND p.IsSold = 'Y' AND p.IsPurchased = 'Y'

GROUP BY bp.C_BPartner_ID, p.M_Product_ID, uom.C_UOM_ID, us.AD_User_ID) AS Master

GROUP BY Master.Partner, Master.Item, Master.UOM, Master.now, Master.User
ORDER BY TRIM(Master.Partner), Master.Item]]>
	</queryString>
	<field name="partner" class="java.lang.String"/>
	<field name="item" class="java.lang.String"/>
	<field name="qtysale" class="java.math.BigDecimal"/>
	<field name="sale" class="java.math.BigDecimal"/>
	<field name="qtyretur" class="java.math.BigDecimal"/>
	<field name="retur" class="java.math.BigDecimal"/>
	<field name="uom" class="java.lang.String"/>
	<field name="now" class="java.sql.Timestamp"/>
	<field name="user" class="java.lang.String"/>
	<variable name="qtynetto" class="java.math.BigDecimal" resetType="Column">
		<variableExpression><![CDATA[$F{qtysale}.subtract($F{qtyretur})]]></variableExpression>
	</variable>
	<variable name="nettoamount" class="java.math.BigDecimal" resetType="Column">
		<variableExpression><![CDATA[$F{sale}.subtract($F{retur})]]></variableExpression>
	</variable>
	<variable name="no" class="java.lang.Integer" calculation="Count">
		<variableExpression><![CDATA[$V{no} == null ? 1 : $V{no} + 1]]></variableExpression>
	</variable>
	<background>
		<band splitType="Stretch"/>
	</background>
	<title>
		<band height="20">
			<subreport>
				<reportElement uuid="40310b28-332a-49b7-ba40-40f360c8bfc7" x="0" y="0" width="802" height="20" isRemoveLineWhenBlank="true">
					<printWhenExpression><![CDATA[$P{ReportType} == "SUM"]]></printWhenExpression>
				</reportElement>
				<subreportParameter name="AD_User_ID">
					<subreportParameterExpression><![CDATA[$P{AD_User_ID}]]></subreportParameterExpression>
				</subreportParameter>
				<subreportParameter name="DateFrom">
					<subreportParameterExpression><![CDATA[$P{DateFrom}]]></subreportParameterExpression>
				</subreportParameter>
				<subreportParameter name="DateTo">
					<subreportParameterExpression><![CDATA[$P{DateTo}]]></subreportParameterExpression>
				</subreportParameter>
				<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
				<subreportExpression><![CDATA[$P{SUBREPORT_DIR} + "SalesReportBasedOnSupplier_Subreport1.jasper"]]></subreportExpression>
			</subreport>
			<subreport>
				<reportElement uuid="40310b28-332a-49b7-ba40-40f360c8bfc7" x="0" y="0" width="802" height="20" isRemoveLineWhenBlank="true">
					<printWhenExpression><![CDATA[$P{ReportType} == "DET"]]></printWhenExpression>
				</reportElement>
				<subreportParameter name="DateTo">
					<subreportParameterExpression><![CDATA[$P{DateTo}]]></subreportParameterExpression>
				</subreportParameter>
				<subreportParameter name="DateFrom">
					<subreportParameterExpression><![CDATA[$P{DateFrom}]]></subreportParameterExpression>
				</subreportParameter>
				<subreportParameter name="AD_User_ID">
					<subreportParameterExpression><![CDATA[$P{AD_User_ID}]]></subreportParameterExpression>
				</subreportParameter>
				<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
				<subreportExpression><![CDATA[$P{SUBREPORT_DIR} + "SalesReportBasedOnSupplier_Subreport2.jasper"]]></subreportExpression>
			</subreport>
		</band>
	</title>
</jasperReport>
